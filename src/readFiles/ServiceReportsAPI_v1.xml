<?xml version="1.0" encoding="UTF-8"?>
<api context="/serviceReports" name="ServiceReportsAPI_v1" version="v1" version-type="url" xmlns="http://ws.apache.org/ns/synapse">
<!-- depreciada -->
    <resource methods="GET" uri-template="/serviceContract/{param}">
        <inSequence>
            <!-- --><log level="custom">
                <!-- --><property name="Endpoint foi depreciado." value="nova funcionalidade na API DataExportsAPI"/>
            <!-- --></log>
            <log level="custom">
                <property name="entrando no endpoint ServiceContract" value="-----"/>
            </log>
            <enrich>
                <source clone="true" type="body"/>
                <target property="payload_inicial" type="property"/>
            </enrich>
            <property name="query" scope="default" type="STRING" value="select Id, OwnerId, IsDeleted, Name, RecordTypeId, CreatedDate, CreatedById, LastModifiedDate, LastModifiedById, SystemModstamp, LastViewedDate, LastReferencedDate, AccountId, ContactId, Term, StartDate, EndDate, ActivationDate, ApprovalStatus, Description, BillingStreet, BillingCity, BillingState, BillingPostalCode, BillingCountry, BillingStateCode, BillingCountryCode, BillingLatitude, BillingLongitude, BillingGeocodeAccuracy, BillingAddress, ShippingStreet, ShippingCity, ShippingState, ShippingPostalCode, ShippingCountry, ShippingStateCode, ShippingCountryCode, ShippingLatitude, ShippingLongitude, ShippingGeocodeAccuracy, ShippingAddress, Pricebook2Id, ShippingHandling, Tax, Subtotal, TotalPrice, LineItemCount, ContractNumber, SpecialTerms, Discount, GrandTotal, Status, ParentServiceContractId, RootServiceContractId, OpportunityOrigin__c, PaymentCondition__c, MinimumStay__c, TermType__c, WorkOrderComments__c, AutomaticRenovation__c, BudgetLimit__c, BusinessHours__c, CNPJ__c, CancellationDate__c, ContractEntitlements__c, ContractModel__c, ContractMonthlyAmount__c, ContractStatus__c, ContractTerm__c, CreateCaseFilter__c, DaysHoursSLA__c, DaysSLAOnSite1DH__c, DaysSLAOnSite2DH__c, DaysSLAOnSite3DH__c, DaysSLAOnSite4DH__c, DaysSLAOnSite5DH__c, DaysSLARemote1DH__c, DaysSLARemote2DH__c, DaysSLARemote3DH__c, DaysSLARemote4DH__c, DaysSLARemote5DH__c, Description__c, DetailCancellation__c, DistributorFeeAmount__c, DistributorFee__c, DistributorRecurrenceInstallments__c, Distributor__c, DocusignEnvelopeCompleted__c, DocusignEnvelopeCreated__c, ExternalId__c, FidelityTerm__c, FrequencyOfBilling__c,GracePeriod__c, InternalSalesExecutive__c, LesserDisplacementChargedValue__c, LesserDisplacementCharged__c, ListHoursSLAOnSite1DH__c, ListHoursSLAOnSite2DH__c, ListHoursSLAOnSite3DH__c, ListHoursSLAOnSite4DH__c, ListHoursSLAOnSite5DH__c, ListHoursSLARemote1DH__c, ListHoursSLARemote2DH__c, ListHoursSLARemote3DH__c, ListHoursSLARemote4DH__c, ListHoursSLARemote5DH__c, MarcosFinishingType__c, NegotiationStatus__c, ReasonForCancellation__c, RecurrenceResaleInstallmentsIntegrad__c, ResellerFeeAmount__c, ResellerFee__c, Reseller__c, SLAOnSite1__c, SLAOnSite2__c, SLAOnSite3__c, SLAOnSite4__c, SLAOnSite5__c, SLARemote1__c, SLARemote2__c, SLARemote3__c, SLARemote4__c, SLARemote5__c, SLAResponseTime__c, SalesExecutive__c, Server__c, ServiceContractAccountType__c, ServiceStatus__c, TotalContractAmount__c, UseParentEntitlement__c, WhichPartCanceled__c, AdditionalTime__c, ContractEntitlementsParents__c, RenewalDate__c, BillingCityStateCodeFormula__c, BillingStreetFormula__c  from ServiceContract WHERE LastModifiedDate =  "/>
            <property expression="fn:concat(get-property('query'),get-property('uri.var.param'))" name="salesforceQuery" scope="default" type="STRING"/>
            <salesforcerest.query configKey="init-salesforce">
                <queryString>{get-property("salesforceQuery")}</queryString>
            </salesforcerest.query>
            <log level="custom">
                <property name="Entrando no filtro" value="------"/>
                <property expression="$ctx:body" name="Body ServiceReportsAPI"/>
            </log>
            <filter regex="0" source="json-eval($.totalSize)">
                <then>
                    <log level="full">
                        <property name="SemRegistros" value="a processar"/>
                    </log>
                </then>
                <else>
                    <payloadFactory media-type="xml">
                        <format>
                            <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
                                <soapenv:Header/>
                                <soapenv:Body>
$1
		   	                    </soapenv:Body>
                            </soapenv:Envelope>
                        </format>
                        <args>
                            <arg evaluator="xml" expression="$body"/>
                        </args>
                    </payloadFactory>
                    <log level="full">
                        <property expression="$ctx:body" name="Loggando o body após o PayloadFactory"/>
                    </log>
                    <enrich>
                        <source clone="true" type="body"/>
                        <target property="payload_inicial" type="property"/>
                    </enrich>
                    <xslt key="conf:transform/TransformJsonServiceContractFirstColumns.xslt"/>
                    <header expression="fn:concat(get-property('env','URL_PLANEJAMENTO'), '/services/ServiceContractDSS.SOAP11Endpoint')" name="To" scope="default"/>
                    <call>
                        <endpoint>
                            <default format="soap12">
                                <suspendOnFailure>
                                    <initialDuration>-1</initialDuration>
                                    <progressionFactor>-1</progressionFactor>
                                    <maximumDuration>0</maximumDuration>
                                </suspendOnFailure>
                                <markForSuspension>
                                    <retriesBeforeSuspension>0</retriesBeforeSuspension>
                                </markForSuspension>
                            </default>
                        </endpoint>
                    </call>
                    <enrich>
                        <source clone="true" property="payload_inicial" type="property"/>
                        <target type="body"/>
                    </enrich>
                    <log>
                        <property name="---- Entrando no segundo Transformador " value="-------"/>
                    </log>
                    <xslt key="conf:transform/TransformJsonServiceContractLastColumns.xslt"/>
                    <header expression="fn:concat(get-property('env','URL_PLANEJAMENTO'), '/services/ServiceContractDSS.SOAP11Endpoint')" name="To" scope="default"/>
                    <call>
                        <endpoint>
                            <default format="soap12">
                                <suspendOnFailure>
                                    <initialDuration>-1</initialDuration>
                                    <progressionFactor>-1</progressionFactor>
                                    <maximumDuration>0</maximumDuration>
                                </suspendOnFailure>
                                <markForSuspension>
                                    <retriesBeforeSuspension>0</retriesBeforeSuspension>
                                </markForSuspension>
                            </default>
                        </endpoint>
                    </call>
                </else>
            </filter>
            <respond/>
        </inSequence>
        <outSequence/>
        <faultSequence/>
    </resource>
    <resource methods="GET" uri-template="/serviceContractLineItem/{param}">
        <inSequence>
            <!-- --><log level="custom">
                <!-- --><property name="Endpoint foi depreciado." value="nova funcionalidade na API DataExportsAPI"/>
            <!-- --></log>
            <log level="custom">
                <property name="Entrando no ServiceContractLineItem" value="-----"/>
            </log>
            <property name="query" scope="default" type="STRING" value="select Id, IsDeleted, LineItemNumber, CreatedDate, CreatedById, LastModifiedDate, LastModifiedById, SystemModstamp, LastViewedDate, LastReferencedDate, ServiceContractId, Product2Id, AssetId, StartDate, EndDate, Description, PricebookEntryId, Quantity, UnitPrice, Discount, ListPrice, Subtotal, TotalPrice, Status, ParentContractLineItemId, RootContractLineItemId, LocationId, BillingStartDate__c, CancellationDate__c, Contract_Additive__c, Enlargement__c, InstalationDate__c, IsServiceProduct__c, ProductName__c, RentalPurpose__c, Status__c from ContractLineItem WHERE LastModifiedDate = "/>
            <property expression="fn:concat(get-property('query'),get-property('uri.var.param'))" name="salesforceQuery" scope="default" type="STRING"/>
            <salesforcerest.query configKey="init-salesforce">
                <queryString>{get-property("salesforceQuery")}</queryString>
            </salesforcerest.query>
            <log level="custom">
                <property name="Entrando no filtro" value="------"/>
                <property expression="$ctx:body" name="Body ServiceReportsAPI"/>
            </log>
            <filter regex="0" source="json-eval($.totalSize)">
                <then>
                    <log level="full">
                        <property name="SemRegistros" value="a processar"/>
                    </log>
                </then>
                <else>
                    <payloadFactory media-type="xml">
                        <format>
                            <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
                                <soapenv:Header/>
                                <soapenv:Body>
$1
		   	</soapenv:Body>
                            </soapenv:Envelope>
                        </format>
                        <args>
                            <arg evaluator="xml" expression="$body"/>
                        </args>
                    </payloadFactory>
                    <log level="full" separator="&#xa;">
                        <property expression="$ctx:body" name="Fazendo transformação dos dados"/>
                    </log>
                    <xslt key="conf:transform/TransformJsonServiceContractLineItem.xslt"/>
                    <header expression="fn:concat(get-property('env','URL_PLANEJAMENTO'), '/services/ServiceContractDSS.SOAP11Endpoint')" name="To" scope="default"/>
                    <call>
                        <endpoint>
                            <default format="soap12">
                                <suspendOnFailure>
                                    <initialDuration>-1</initialDuration>
                                    <progressionFactor>-1</progressionFactor>
                                    <maximumDuration>0</maximumDuration>
                                </suspendOnFailure>
                                <markForSuspension>
                                    <retriesBeforeSuspension>0</retriesBeforeSuspension>
                                </markForSuspension>
                            </default>
                        </endpoint>
                    </call>
                </else>
            </filter>
            <respond/>
        </inSequence>
        <outSequence/>
        <faultSequence/>
    </resource>
</api>
