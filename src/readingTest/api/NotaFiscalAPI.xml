<?xml version="1.0" encoding="UTF-8"?>
<api context="/nota-fiscal" name="NotaFiscalAPI" xmlns="http://ws.apache.org/ns/synapse">
    <resource methods="GET" uri-template="/v1/devolucao/{cpfCnpj}/{serie}/{numero}">
        <inSequence>
            <log level="custom">
                <property name="--> " value="Requisitando recebida! - /nota-fiscal/v1/devolucao/{cpfCnpj}/{serie}/{numero}"/>
            </log>
            <property name="DISABLE_CHUNKING" scope="axis2" type="STRING" value="true"/>
            <property action="remove" name="REST_URL_POSTFIX" scope="axis2"/>
            <sequence key="SetHeaders"/>
            <log level="custom">
                <property expression="get-property('uri.var.host.ERP')" name="--> "/>
                <property expression="get-property('uri.var.host.APIPROGRESS')" name="--> "/>
            </log>
            <send>
                <endpoint>
                    <http method="get" uri-template="{uri.var.host.APIPROGRESS}/services/ProgressDSS/nota-fiscal/devolucao?numeroNota={uri.var.numero}&amp;numeroSerie={uri.var.serie}&amp;cnpj={uri.var.cpfCnpj}">
                        <timeout>
                            <duration>40000</duration>
                            <responseAction>fault</responseAction>
                        </timeout>
                        <suspendOnFailure>
                            <initialDuration>-1</initialDuration>
                            <progressionFactor>1</progressionFactor>
                        </suspendOnFailure>
                        <markForSuspension>
                            <retriesBeforeSuspension>0</retriesBeforeSuspension>
                        </markForSuspension>
                    </http>
                </endpoint>
            </send>
        </inSequence>
        <outSequence>
            <send/>
        </outSequence>
        <faultSequence/>
    </resource>
    <resource methods="GET" uri-template="/v1/nota/{externalIdConsumer}/{startDate}/{endDate}">
        <inSequence>
            <log level="custom">
                <property name="--> " value="Requisicao recebida! - /v1/nota/{externalIdConsumer}/{startDate}/{endDate}"/>
            </log>
            <property name="DISABLE_CHUNKING" scope="axis2" type="STRING" value="true"/>
            <property action="remove" name="REST_URL_POSTFIX" scope="axis2"/>
            <sequence key="SetHeaders"/>
            <log level="custom">
                <property expression="get-property('uri.var.host.APIPROGRESS')" name="--> "/>
                <property expression="get-property('uri.var.externalIdConsumer')" name="--> "/>
                <property expression="get-property('uri.var.startDate')" name="--> "/>
                <property expression="get-property('uri.var.endDate')" name="--> "/>
            </log>
            <send>
                <endpoint>
                    <http method="get" uri-template="{uri.var.host.APIPROGRESS}/nota-fiscal/v1/nota/{uri.var.externalIdConsumer}/{uri.var.startDate}/{uri.var.endDate}">
                        <timeout>
                            <duration>40000</duration>
                            <responseAction>fault</responseAction>
                        </timeout>
                        <suspendOnFailure>
                            <initialDuration>-1</initialDuration>
                            <progressionFactor>1</progressionFactor>
                        </suspendOnFailure>
                        <markForSuspension>
                            <retriesBeforeSuspension>0</retriesBeforeSuspension>
                        </markForSuspension>
                    </http>
                </endpoint>
            </send>
        </inSequence>
        <outSequence>
            <send/>
        </outSequence>
        <faultSequence/>
    </resource>
    <resource methods="GET" uri-template="/v1/nota/{externalIdConsumer}/{orderCode}">
        <inSequence>
            <log level="custom">
                <property name="--> " value="Requisicao recebida! - /v1/nota/{externalId}/{orderCode}"/>
            </log>
            <property name="DISABLE_CHUNKING" scope="axis2" type="STRING" value="true"/>
            <property action="remove" name="REST_URL_POSTFIX" scope="axis2"/>
            <sequence key="SetHeaders"/>
            <log level="custom">
                <property expression="get-property('uri.var.host.APIPROGRESS')" name="--> "/>
                <property expression="get-property('uri.var.externalIdConsumer')" name="--> "/>
                <property expression="get-property('uri.var.orderCode')" name="--> "/>
            </log>
            <call>
                <endpoint>
                    <http method="get" uri-template="{uri.var.host.APIPROGRESS}/nota-fiscal/v1/nota/{uri.var.externalIdConsumer}/{uri.var.orderCode}">
                        <timeout>
                            <duration>40000</duration>
                            <responseAction>fault</responseAction>
                        </timeout>
                        <suspendOnFailure>
                            <initialDuration>-1</initialDuration>
                            <progressionFactor>1</progressionFactor>
                        </suspendOnFailure>
                        <markForSuspension>
                            <retriesBeforeSuspension>0</retriesBeforeSuspension>
                        </markForSuspension>
                    </http>
                </endpoint>
            </call>
            <filter regex="200" source="$axis2:HTTP_SC">
                <then>
                    <filter regex="true" source="boolean(count(//nfNumber)>0)">
                        <then>
                            <log level="custom" separator="&#xa;&#x9;">
                                <property expression="json-eval($)" name="--> Payload"/>
                            </log>
                            <iterate attachPath="json-eval($)" expression="json-eval($.nfs.nf)" id="iterate" preservePayload="true" sequential="true">
                                <target>
                                    <sequence>
                                        <header name="Content-Type" scope="transport" value="application/json"/>
                                        <sequence key="BuscarRastreamentoSequence"/>
                                    </sequence>
                                </target>
                            </iterate>
                            <property name="info" scope="default">
                                <jsonObject/>
                            </property>
                            <aggregate id="iterate">
                                <correlateOn expression="json-eval($)"/>
                                <completeCondition>
                                    <messageCount max="-1" min="-1"/>
                                </completeCondition>
                                <onComplete aggregateElementType="root" expression="json-eval($)">
                                    <log level="custom" separator="&#xa;&#x9;">
                                        <property expression="json-eval($)" name="inside Aggregator"/>
                                    </log>
                                    <property name="messageType" scope="axis2" type="STRING" value="application/json"/>
                                    <payloadFactory media-type="json">
                                        <format>
									{"nfs":{"nf": $1}}
								</format>
                                        <args>
                                            <arg evaluator="json" expression="$"/>
                                        </args>
                                    </payloadFactory>
                                    <send/>
                                </onComplete>
                            </aggregate>
                            <property name="FORCE_SC_ACCEPTED" scope="axis2" type="STRING" value="true"/>
                        </then>
                        <else>
                            <payloadFactory media-type="text">
                                <format/>
                                <args/>
                            </payloadFactory>
                            <property name="ContentType" scope="axis2" type="STRING" value="application/json"/>
                            <property name="HTTP_SC" scope="axis2" type="STRING" value="404"/>
                            <respond/>
                        </else>
                    </filter>
                </then>
                <else/>
            </filter>
            <respond/>
        </inSequence>
        <outSequence/>
        <faultSequence/>
    </resource>
    <resource methods="GET" uri-template="/v1/nota-entrada/{numeroNota}/{numeroSerie}/{codEmitente}/{estabelecimento}">
        <inSequence>
            <property name="DISABLE_CHUNKING" scope="axis2" type="STRING" value="true"/>
            <property action="remove" name="REST_URL_POSTFIX" scope="axis2"/>
            <sequence key="SetHeaders"/>
            <log level="custom">
                <property expression="get-property('uri.var.host.ERP')" name="--> "/>
                <property expression="get-property('uri.var.host.APIPROGRESS')" name="--> "/>
            </log>
            <send>
                <endpoint>
                    <http method="get" uri-template="{uri.var.host.APIPROGRESS}/services/ProgressDSS/nota-fiscal/entrada/numeroNota/{uri.var.numeroNota}/numeroSerie/{uri.var.numeroSerie}/codEmitente/{uri.var.codEmitente}/estabelecimento/{uri.var.estabelecimento}">
                        <timeout>
                            <duration>40000</duration>
                            <responseAction>fault</responseAction>
                        </timeout>
                        <suspendOnFailure>
                            <initialDuration>-1</initialDuration>
                            <progressionFactor>1</progressionFactor>
                        </suspendOnFailure>
                        <markForSuspension>
                            <retriesBeforeSuspension>0</retriesBeforeSuspension>
                        </markForSuspension>
                    </http>
                </endpoint>
            </send>
        </inSequence>
        <outSequence>
            <send/>
        </outSequence>
        <faultSequence/>
    </resource>
    <resource methods="GET" uri-template="/v1/notas-fiscais/{numeroNota}/{numeroSerie}/{cgc}">
        <inSequence>
            <property name="DISABLE_CHUNKING" scope="axis2" type="STRING" value="true"/>
            <property action="remove" name="REST_URL_POSTFIX" scope="axis2"/>
            <sequence key="SetHeaders"/>
            <log level="custom">
                <property expression="get-property('uri.var.host.ERP')" name="--> "/>
                <property expression="get-property('uri.var.host.APIPROGRESS')" name="--> "/>
            </log>
            <send>
                <endpoint>
                    <http method="get" uri-template="{uri.var.host.APIPROGRESS}/services/ProgressDSS/notas-fiscais/numeroNota/{uri.var.numeroNota}/numeroSerie/{uri.var.numeroSerie}/cgc/{uri.var.cgc}">
                        <timeout>
                            <duration>40000</duration>
                            <responseAction>fault</responseAction>
                        </timeout>
                        <suspendOnFailure>
                            <initialDuration>-1</initialDuration>
                            <progressionFactor>1</progressionFactor>
                        </suspendOnFailure>
                        <markForSuspension>
                            <retriesBeforeSuspension>0</retriesBeforeSuspension>
                        </markForSuspension>
                    </http>
                </endpoint>
            </send>
        </inSequence>
        <outSequence>
            <send/>
        </outSequence>
        <faultSequence/>
    </resource>
    <resource methods="GET" uri-template="/v1/nota/documentos/{numeroNota}/{numeroSerie}/{estabelecimento}/{cgc}">
        <inSequence>
            <log level="custom">
                <property name="--> " value="Requisicao recebida! - /v1/nota/documentos/{numeroNota}/{numeroSerie}/{estabelecimento}/{cgc}"/>
            </log>
            <property name="DISABLE_CHUNKING" scope="axis2" type="STRING" value="true"/>
            <property action="remove" name="REST_URL_POSTFIX" scope="axis2"/>
            <sequence key="SetHeaders"/>
            <log level="custom">
                <property expression="get-property('uri.var.host.APIPROGRESS')" name="--> "/>
                <property expression="get-property('uri.var.numeroNota')" name="--> "/>
                <property expression="get-property('uri.var.numeroSerie')" name="--> "/>
                <property expression="get-property('uri.var.estabelecimento')" name="--> "/>
                <property expression="get-property('uri.var.cgc')" name="--> "/>
            </log>
            <send>
                <endpoint>
                    <http method="get" uri-template="{uri.var.host.APIPROGRESS}/nota-fiscal/v1/nota/documentos/{uri.var.numeroNota}/{uri.var.numeroSerie}/{uri.var.estabelecimento}/{uri.var.cgc}">
                        <timeout>
                            <duration>120000</duration>
                            <responseAction>fault</responseAction>
                        </timeout>
                        <suspendOnFailure>
                            <initialDuration>-1</initialDuration>
                            <progressionFactor>1</progressionFactor>
                        </suspendOnFailure>
                        <markForSuspension>
                            <retriesBeforeSuspension>0</retriesBeforeSuspension>
                        </markForSuspension>
                    </http>
                </endpoint>
            </send>
        </inSequence>
        <outSequence>
            <send/>
        </outSequence>
        <faultSequence/>
    </resource>
    <resource methods="GET" uri-template="/v1/notas-fiscais-estrangeira/{numeroNota}/{numeroSerie}/{codEmitente}">
        <inSequence>
            <property name="DISABLE_CHUNKING" scope="axis2" type="STRING" value="true"/>
            <property action="remove" name="REST_URL_POSTFIX" scope="axis2"/>
            <sequence key="SetHeaders"/>
            <log level="custom">
                <property expression="get-property('uri.var.host.ERP')" name="--> "/>
                <property expression="get-property('uri.var.host.APIPROGRESS')" name="--> "/>
            </log>
            <send>
                <endpoint>
                    <http method="get" uri-template="{uri.var.host.APIPROGRESS}/services/ProgressDSS/notas-fiscais-estrangeira/numeroNota/{uri.var.numeroNota}/numeroSerie/{uri.var.numeroSerie}/codEmitente/{uri.var.codEmitente}">
                        <timeout>
                            <duration>40000</duration>
                            <responseAction>fault</responseAction>
                        </timeout>
                        <suspendOnFailure>
                            <initialDuration>-1</initialDuration>
                            <progressionFactor>1</progressionFactor>
                        </suspendOnFailure>
                        <markForSuspension>
                            <retriesBeforeSuspension>0</retriesBeforeSuspension>
                        </markForSuspension>
                    </http>
                </endpoint>
            </send>
        </inSequence>
        <outSequence>
            <send/>
        </outSequence>
        <faultSequence/>
    </resource>
</api>
