<?xml version="1.0" encoding="UTF-8"?>
<api context="/contato" name="ContatoAPI" xmlns="http://ws.apache.org/ns/synapse">
    <resource methods="GET" uri-template="/v1/existe/cpfCnpj/{cpfCnpj}">
        <inSequence>
            <log level="custom">
                <property name="--> " value="Requisitando recebida! - /v1/contato/existe/cpfCnpj/{cpfCnpj}"/>
            </log>
            <header action="remove" name="Content-Type" scope="transport"/>
            <call>
                <endpoint>
                    <http method="get" uri-template="http://localhost:8290/services/CRMDynamicsDSS/contato?where=new_cpf_sem_mascara='{uri.var.cpfCnpj}'%20or%20itbc_cpfoucnpj='{uri.var.cpfCnpj}'">
                        <suspendOnFailure>
                            <initialDuration>-1</initialDuration>
                            <progressionFactor>1</progressionFactor>
                        </suspendOnFailure>
                        <markForSuspension>
                            <retriesBeforeSuspension>0</retriesBeforeSuspension>
                        </markForSuspension>
                    </http>
                </endpoint>
            </call>
            <property expression="$body//*[local-name()='ContactId']/text()" name="ContactId" scope="default" type="STRING"/>
            <filter regex="200" source="$axis2:HTTP_SC">
                <then>
                    <filter regex="true" source="boolean(get-property('ContactId'))">
                        <then>
                            <property name="HTTP_SC" scope="axis2" type="STRING" value="200"/>
                            <payloadFactory media-type="json">
                                <format>
									{"existe": $1}
								</format>
                                <args>
                                    <arg value="true"/>
                                </args>
                            </payloadFactory>
                        </then>
                        <else>
                            <property name="HTTP_SC" scope="axis2" type="STRING" value="404"/>
                            <payloadFactory media-type="json">
                                <format>
									{"existe": $1}
								</format>
                                <args>
                                    <arg value="false"/>
                                </args>
                            </payloadFactory>
                        </else>
                    </filter>
                </then>
                <else>
                    <property name="HTTP_SC" scope="axis2" type="STRING" value="500"/>
                    <payloadFactory media-type="json">
                        <format>
							&#xd; {&#xd; "result": "$1"&#xd; }&#xd;
						</format>
                        <args>
                            <arg evaluator="xml" expression="/soapenv:Body/soapenv:Fault/faultstring" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"/>
                        </args>
                    </payloadFactory>
                </else>
            </filter>
            <log level="custom">
                <property name="--> " value="Requisitando finalizada!"/>
            </log>
            <respond/>
        </inSequence>
        <outSequence/>
        <faultSequence/>
    </resource>
    <resource methods="GET" uri-template="/v1/existe/email/{email}">
        <inSequence>
            <log level="custom">
                <property name="--> " value="Requisitando recebida! - /v1/contato/existe/email/{email}"/>
            </log>
            <header action="remove" name="Content-Type" scope="transport"/>
            <call>
                <endpoint>
                    <http method="get" uri-template="http://localhost:8290/services/CRMDynamicsDSS/contato?where=emailaddress1='{uri.var.email}'">
                        <suspendOnFailure>
                            <initialDuration>-1</initialDuration>
                            <progressionFactor>1</progressionFactor>
                        </suspendOnFailure>
                        <markForSuspension>
                            <retriesBeforeSuspension>0</retriesBeforeSuspension>
                        </markForSuspension>
                    </http>
                </endpoint>
            </call>
            <property expression="$body//*[local-name()='ContactId']/text()" name="ContactId" scope="default" type="STRING"/>
            <filter regex="200" source="$axis2:HTTP_SC">
                <then>
                    <filter regex="true" source="boolean(get-property('ContactId'))">
                        <then>
                            <property name="HTTP_SC" scope="axis2" type="STRING" value="200"/>
                            <payloadFactory media-type="json">
                                <format>
									{"existe": $1}
								</format>
                                <args>
                                    <arg value="true"/>
                                </args>
                            </payloadFactory>
                        </then>
                        <else>
                            <property name="HTTP_SC" scope="axis2" type="STRING" value="404"/>
                            <payloadFactory media-type="json">
                                <format>
									{"existe": $1}
								</format>
                                <args>
                                    <arg value="false"/>
                                </args>
                            </payloadFactory>
                        </else>
                    </filter>
                </then>
                <else>
                    <property name="HTTP_SC" scope="axis2" type="STRING" value="500"/>
                    <payloadFactory media-type="json">
                        <format>
							&#xd; {&#xd; "result": "$1"&#xd; }&#xd;
						</format>
                        <args>
                            <arg evaluator="xml" expression="/soapenv:Body/soapenv:Fault/faultstring" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"/>
                        </args>
                    </payloadFactory>
                </else>
            </filter>
            <log level="custom">
                <property name="--> " value="Requisitando finalizada!"/>
            </log>
            <respond/>
        </inSequence>
        <outSequence/>
        <faultSequence/>
    </resource>
    <resource methods="GET" uri-template="/v1/{cpfCnpj}">
        <inSequence>
            <log level="custom">
                <property name="--> " value="Requisitando recebida! - /v1/contato/{cpfCnpj}"/>
            </log>
            <header action="remove" name="Content-Type" scope="transport"/>
            <call>
                <endpoint>
                    <http method="get" uri-template="http://localhost:8290/services/CRMDynamicsDSS/contato?where=new_cpf_sem_mascara='{uri.var.cpfCnpj}'#itbc_cpfoucnpj='{uri.var.cpfCnpj}'">
                        <suspendOnFailure>
                            <initialDuration>-1</initialDuration>
                            <progressionFactor>1</progressionFactor>
                        </suspendOnFailure>
                        <markForSuspension>
                            <retriesBeforeSuspension>0</retriesBeforeSuspension>
                        </markForSuspension>
                    </http>
                </endpoint>
            </call>
            <property expression="$body//*[local-name()='ContactId']/text()" name="ContactId" scope="default" type="STRING"/>
            <filter regex="200" source="$axis2:HTTP_SC">
                <then>
                    <filter regex="true" source="boolean(get-property('ContactId'))">
                        <then>
                            <property name="HTTP_SC" scope="axis2" type="STRING" value="200"/>
                        </then>
                        <else>
                            <property name="HTTP_SC" scope="axis2" type="STRING" value="404"/>
                        </else>
                    </filter>
                </then>
                <else>
                    <property name="HTTP_SC" scope="axis2" type="STRING" value="500"/>
                    <payloadFactory media-type="json">
                        <format>
							&#xd; {&#xd; "result": "$1"&#xd; }&#xd;
						</format>
                        <args>
                            <arg evaluator="xml" expression="/soapenv:Body/soapenv:Fault/faultstring" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"/>
                        </args>
                    </payloadFactory>
                </else>
            </filter>
            <log level="custom">
                <property name="--> " value="Requisitando finalizada!"/>
            </log>
            <respond/>
        </inSequence>
        <outSequence/>
        <faultSequence/>
    </resource>
    <resource methods="GET" uri-template="/v1/email/{email}">
        <inSequence>
            <log level="custom">
                <property name="--> " value="Requisitando recebida! - /v1/contato/email/{email}"/>
            </log>
            <header action="remove" name="Content-Type" scope="transport"/>
            <call>
                <endpoint>
                    <http method="get" uri-template="http://localhost:8290/services/CRMDynamicsDSS/contato?where=emailaddress1='{uri.var.email}'">
                        <suspendOnFailure>
                            <initialDuration>-1</initialDuration>
                            <progressionFactor>1</progressionFactor>
                        </suspendOnFailure>
                        <markForSuspension>
                            <retriesBeforeSuspension>0</retriesBeforeSuspension>
                        </markForSuspension>
                    </http>
                </endpoint>
            </call>
            <property expression="$body//*[local-name()='ContactId']/text()" name="ContactId" scope="default" type="STRING"/>
            <filter regex="200" source="$axis2:HTTP_SC">
                <then>
                    <filter regex="true" source="boolean(get-property('ContactId'))">
                        <then>
                            <property name="HTTP_SC" scope="axis2" type="STRING" value="200"/>
                        </then>
                        <else>
                            <property name="HTTP_SC" scope="axis2" type="STRING" value="404"/>
                        </else>
                    </filter>
                </then>
                <else>
                    <property name="HTTP_SC" scope="axis2" type="STRING" value="500"/>
                    <payloadFactory media-type="json">
                        <format>
							&#xd; {&#xd; "result": "$1"&#xd; }&#xd;
						</format>
                        <args>
                            <arg evaluator="xml" expression="/soapenv:Body/soapenv:Fault/faultstring" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"/>
                        </args>
                    </payloadFactory>
                </else>
            </filter>
            <log level="custom">
                <property name="--> " value="Requisitando finalizada!"/>
            </log>
            <respond/>
        </inSequence>
        <outSequence/>
        <faultSequence/>
    </resource>
</api>
