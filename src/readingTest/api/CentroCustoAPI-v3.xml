<?xml version="1.0" encoding="UTF-8"?>
<api context="/centro-custo/v3" name="CentroCustoAPI-v3" xmlns="http://ws.apache.org/ns/synapse">
    <resource methods="GET" url-mapping="/centro-custo">
        <inSequence>
            <script language="js"><![CDATA[var codigo = mc.getProperty("query.param.codigo");
var estabelecimento = mc.getProperty("query.param.estabelecimento");
var descricao = mc.getProperty("query.param.descricao");

//var log = mc.getServiceLog();
//log.info('query.param.codigo = ' + codigo);
//log.info('query.param.estabelecimento = ' + estabelecimento);
//log.info('query.param.descricao = ' + descricao);

if (codigo != null && estabelecimento!= null) {
    mc.setProperty("PARAMETRO_CONSULTA", "codigoEstabelecimento");
} else if (codigo != null && estabelecimento == null){
    mc.setProperty("PARAMETRO_CONSULTA", "codigo");
} else if (descricao != null) {
mc.setProperty("PARAMETRO_CONSULTA", "descricao");
}]]></script>
            <switch source="$ctx:PARAMETRO_CONSULTA">
                <case regex="descricao">
                    <log level="custom" separator="&#x9;&#xa;">
                        <property name="--> " value="Requisitando recebida! - /centro-custo/v3/centro-custo?descricao={value}"/>
                    </log>
                    <sequence key="SetHeaders"/>
                    <call>
                        <endpoint key="ListarCentroCustoEndpoind"/>
                    </call>
                    <property name="ContentType" scope="axis2" type="STRING" value="application/xml"/>
                    <xslt key="conf:transform/TransformCentroCustoDescricao-v2.xslt">
                        <property expression="$ctx:query.param.descricao" name="PARAM_DESCRICAO"/>
                    </xslt>
                    <log level="custom" separator="&#x9;&#xa;">
                        <property name="--> " value="Requisitando finalizada!"/>
                    </log>
                </case>
                <case regex="codigo">
                    <log level="custom" separator="&#x9;&#xa;">
                        <property name="--> " value="Requisitando recebida! - /centro-custo/v3/centro-custo?codigo={value}"/>
                    </log>
                    <sequence key="SetHeaders"/>
                    <call>
                        <endpoint>
                            <http method="get" uri-template="{uri.var.host.APIPROGRESS}/services/ProgressDSS/centro-custo/codigo/{query.param.codigo}">
                                <suspendOnFailure>
                                    <initialDuration>-1</initialDuration>
                                    <progressionFactor>-1</progressionFactor>
                                    <maximumDuration>0</maximumDuration>
                                </suspendOnFailure>
                                <markForSuspension>
                                    <retriesBeforeSuspension>0</retriesBeforeSuspension>
                                </markForSuspension>
                            </http>
                        </endpoint>
                    </call>
                    <log level="custom" separator="&#x9;&#xa;">
                        <property name="--> " value="Requisitando finalizada!"/>
                    </log>
                </case>
                <case regex="codigoEstabelecimento">
                    <log level="custom" separator="&#x9;&#xa;">
                        <property name="--> " value="Requisitando recebida! - /centro-custo/v3/centro-custo?codigo={value}ANDestabelecimento={value}"/>
                    </log>
                    <sequence key="SetHeaders"/>
                    <call>
                        <endpoint>
                            <http method="get" uri-template="{uri.var.host.APIPROGRESS}/services/ProgressDSS/centro-custo/codigo/{query.param.codigo}/estabelecimento/{query.param.estabelecimento}">
                                <suspendOnFailure>
                                    <initialDuration>-1</initialDuration>
                                    <progressionFactor>-1</progressionFactor>
                                    <maximumDuration>0</maximumDuration>
                                </suspendOnFailure>
                                <markForSuspension>
                                    <retriesBeforeSuspension>0</retriesBeforeSuspension>
                                </markForSuspension>
                            </http>
                        </endpoint>
                    </call>
                    <log level="custom" separator="&#x9;&#xa;">
                        <property name="--> " value="Requisitando finalizada!"/>
                    </log>
                </case>
                <default>
                    <log level="custom" separator="&#x9;&#xa;">
                        <property name="--> " value="Requisitando recebida! - /centro-custo/v3/centro-custo"/>
                    </log>
                    <sequence key="SetHeaders"/>
                    <call>
                        <endpoint key="ListarCentroCustoEndpoind"/>
                    </call>
                    <log level="custom" separator="&#x9;&#xa;">
                        <property name="--> " value="Requisitando finalizada!"/>
                    </log>
                </default>
            </switch>
            <property name="messageType" scope="axis2" type="STRING" value="application/json"/>
            <respond/>
        </inSequence>
        <outSequence/>
        <faultSequence/>
    </resource>
</api>
