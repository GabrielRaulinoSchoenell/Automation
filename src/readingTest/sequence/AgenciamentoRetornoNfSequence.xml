<?xml version="1.0" encoding="UTF-8"?>
<sequence name="AgenciamentoRetornoNfSequence" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <script language="js"><![CDATA[var pedidoCliente = mc.getProperty('pedidoCliente');
    pedidoCliente = pedidoCliente.replace("MKT-", "");
	mc.setProperty("pedidoCliente", pedidoCliente);
	
	var dataEmissao = mc.getProperty('dataEmissao');	
	var newDate = new Date(dataEmissao.toString().substring(5, 7) + "/" + dataEmissao.toString().substring(8, 10) + "/" + dataEmissao.toString().substring(0, 4)).toISOString();
	mc.setProperty("dataEmissao", newDate);]]></script>
    <payloadFactory media-type="json">
        <format>
				{
				"invoicedNumber": "$1",
				"invoicedKey": "$2",
				"invoicedDate": "$3",
				"invoicedUrl": "$4",
				"orderId": "$5"
				}
			</format>
        <args>
            <arg evaluator="xml" expression="$ctx:numeroNota" xmlns:ns="http://org.apache.synapse/xsd"/>
            <arg evaluator="xml" expression="$ctx:chaveAcesso" xmlns:ns="http://org.apache.synapse/xsd"/>
            <arg evaluator="xml" expression="$ctx:dataEmissao" xmlns:ns="http://org.apache.synapse/xsd"/>
            <arg value=""/>
            <arg evaluator="xml" expression="$ctx:pedidoCliente" xmlns:ns="http://org.apache.synapse/xsd"/>
        </args>
    </payloadFactory>
    <log level="custom">
        <property name="--> " value="Apos payloadFactory"/>
        <property expression="$ctx:numeroNota" name="numeroNota"/>
        <property expression="$ctx:chaveAcesso" name="chaveAcesso"/>
        <property expression="$ctx:dataEmissao" name="dataEmissao"/>
        <property expression="$ctx:pedidoCliente" name="pedidoCliente"/>
    </log>
    <call>
        <endpoint>
            <http method="put" uri-template="{uri.var.host.URLAGENCIAMENTONF}/order/invoiceEndPoint">
                <suspendOnFailure>
                    <initialDuration>-1</initialDuration>
                    <progressionFactor>-1</progressionFactor>
                    <maximumDuration>0</maximumDuration>
                </suspendOnFailure>
                <markForSuspension>
                    <retriesBeforeSuspension>0</retriesBeforeSuspension>
                </markForSuspension>
            </http>
        </endpoint>
    </call>
    <log level="custom">
        <property expression="$axis2:HTTP_SC" name="status"/>
        <property expression="//message/text()" name="message"/>
    </log>
</sequence>
